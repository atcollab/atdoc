<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of atfrommadx</title>
  <meta name="keywords" content="atfrommadx">
  <meta name="description" content="function atfrommadx(seqfilemadX,E0,outfilename)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../../../menu.html atmat --><!-- ../../menu.html lattice --><!-- ../menu.html Converters --><!-- menu.html MADX2AT --><h1>atfrommadx
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function atfrommadx(seqfilemadX,E0,outfilename)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function atfrommadx(seqfilemadX,E0,outfilename) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../../../atcollab.png)"><pre class="comment">function atfrommadx(seqfilemadX,E0,outfilename)
 tansform madX sequence file (savesequence) file into AT lattice structure.

 This procedure reads a saved lattice (sequence in madx) in madX
 and converts it to an AT lattice

 (madx comands to save the sequences :

  _______ MADX code _________
  use,period=sequencename1;
  use,period=sequencename2;
  use,period=sequencename2;
  SAVE,FILE='seqfilemadX.seq';
  ___________________________

  seqfilemadX.seq will contain sequencename1 sequencename2 sequencename3
  in the correct format in a single file

 )

 The routine outputs a Matlab macro with all the AT defitions and variables as
 in the madX file

 The order of the declarations is the same in the two files.
 declarations that contain other variables are moved to the end. (this may not be enough)


 Works also with single madX files not containing comands, only
 definitions.

 parameters:
    - seqfilemadX=name of the mad8 lattice file
    - E0  = design energy
    - outfilename (default: seqfilemadX_AT_LATTICE.mat)

 default pass methods:
          quadrupoles : StrMPoleSymplectic4Pass
          dipole : BndMPoleSymplectic4Pass
          multipole : StrMPoleSymplectic4Pass
          sextupole : StrMPoleSymplectic4Pass
          thinmultipole : ThinMPolePass
          correctors : ThinMPolePass
          cavity : DriftPass</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../../../atcollab.png)">
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="../../../../atmat/at.html" class="code" title="">at</a>	This is the Accelerator Toolbox particle tracking code.</li><li><a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>	determines atribute and sets field in sxs{i} structure AT</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="../../../../atmat/lattice/Converters/MADX2AT/Examples/convertMADXtoATExample.html" class="code" title="">convertMADXtoATExample</a>	</li></ul>
</div>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../../../atcollab.png)">
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function tmp=formatTextMADX(str)</a></li></ul>
</div>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../../../atcollab.png)"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function atfrommadx(seqfilemadX,E0,outfilename)</a>
0002 <span class="comment">%function atfrommadx(seqfilemadX,E0,outfilename)</span>
0003 <span class="comment">% tansform madX sequence file (savesequence) file into AT lattice structure.</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% This procedure reads a saved lattice (sequence in madx) in madX</span>
0006 <span class="comment">% and converts it to an AT lattice</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% (madx comands to save the sequences :</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%  _______ MADX code _________</span>
0011 <span class="comment">%  use,period=sequencename1;</span>
0012 <span class="comment">%  use,period=sequencename2;</span>
0013 <span class="comment">%  use,period=sequencename2;</span>
0014 <span class="comment">%  SAVE,FILE='seqfilemadX.seq';</span>
0015 <span class="comment">%  ___________________________</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%  seqfilemadX.seq will contain sequencename1 sequencename2 sequencename3</span>
0018 <span class="comment">%  in the correct format in a single file</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% )</span>
0021 <span class="comment">%</span>
0022 <span class="comment">% The routine outputs a Matlab macro with all the AT defitions and variables as</span>
0023 <span class="comment">% in the madX file</span>
0024 <span class="comment">%</span>
0025 <span class="comment">% The order of the declarations is the same in the two files.</span>
0026 <span class="comment">% declarations that contain other variables are moved to the end. (this may not be enough)</span>
0027 <span class="comment">%</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% Works also with single madX files not containing comands, only</span>
0030 <span class="comment">% definitions.</span>
0031 <span class="comment">%</span>
0032 <span class="comment">% parameters:</span>
0033 <span class="comment">%    - seqfilemadX=name of the mad8 lattice file</span>
0034 <span class="comment">%    - E0  = design energy</span>
0035 <span class="comment">%    - outfilename (default: seqfilemadX_AT_LATTICE.mat)</span>
0036 <span class="comment">%</span>
0037 <span class="comment">% default pass methods:</span>
0038 <span class="comment">%          quadrupoles : StrMPoleSymplectic4Pass</span>
0039 <span class="comment">%          dipole : BndMPoleSymplectic4Pass</span>
0040 <span class="comment">%          multipole : StrMPoleSymplectic4Pass</span>
0041 <span class="comment">%          sextupole : StrMPoleSymplectic4Pass</span>
0042 <span class="comment">%          thinmultipole : ThinMPolePass</span>
0043 <span class="comment">%          correctors : ThinMPolePass</span>
0044 <span class="comment">%          cavity : DriftPass</span>
0045 <span class="comment">%</span>
0046 
0047 <span class="comment">%% changes history</span>
0048 <span class="comment">% created 7-sep-2012 by S.M.Liuzzo @ ESRF</span>
0049 <span class="comment">%</span>
0050 <span class="comment">% updated 12-sep-2012 Cavity DriftPass (not IdentityPass)</span>
0051 <span class="comment">% updated 13-sep-2012 Capital letter names</span>
0052 <span class="comment">%                     CorrectorPass</span>
0053 <span class="comment">%                     _red reduced versions</span>
0054 <span class="comment">% updated 14-sep-2012 multipoles (1/n!) factor from madx to AT</span>
0055 <span class="comment">% updated 21-dec-2012 rbend-sbend length conversion corrected</span>
0056 <span class="comment">% updated 05-mar-2013 lattice output no fringes and with fringes (_FF).</span>
0057 <span class="comment">%</span>
0058 <span class="comment">% updated 20-mar-2013 removed output no fringes and with fringes (_FF).</span>
0059 <span class="comment">%                     removed output reduced (_red).</span>
0060 <span class="comment">%                     use atconstructors.</span>
0061 <span class="comment">%                     call macro directly</span>
0062 <span class="comment">%                     try-catch macro running</span>
0063 <span class="comment">%                     tempname file and fulfile.</span>
0064 
0065 
0066 <span class="comment">%% initial warnings</span>
0067 disp(<span class="string">'important notice about conversion:'</span>)
0068 disp(<span class="string">''</span>);
0069 disp([<span class="string">'1) THE MADX FILE MUST BE OUTPUT OF save, file=seqfilemadX;'</span><span class="keyword">...</span>
0070     <span class="string">' THIS GARANTES AN APPROPRIATE FILE FORMAT'</span>]);
0071 disp(<span class="string">''</span>);
0072 disp([<span class="string">'2) THE MADX PROGRAM allows to use variable not previously defined.'</span><span class="keyword">...</span>
0073     <span class="string">' This is not known to AT!.'</span><span class="keyword">...</span>
0074     <span class="string">' If the program fails but generates a ..._macro.m file, '</span><span class="keyword">...</span>
0075     <span class="string">' please edit this file reordering the declarations and run it.'</span>]);
0076 disp(<span class="string">''</span>);
0077 disp([<span class="string">'3) If periodname is not specified'</span> <span class="keyword">...</span>
0078     <span class="string">' It is assumed the name of the file (up to the .) '</span> <span class="keyword">...</span>
0079     <span class="string">'to be the sequence name that you want to use'</span>]);
0080 
0081 <span class="comment">%% open madX sequence file</span>
0082 sX=fopen(seqfilemadX,<span class="string">'r'</span>);
0083 
0084 <span class="comment">% the : detect definitions. every : is preceded by a name</span>
0085 <span class="comment">% of an element.</span>
0086 <span class="comment">% between two : all the parameter of an elemetn or a line ar found.</span>
0087 
0088 <span class="comment">%% get madX file in a cell array with a new elment at every space comma or new line.</span>
0089 <span class="comment">%SXCELL=textscan(sX,'%s','delimiter',';');</span>
0090 SXCELL=textscan(sX,<span class="string">'%s'</span>,<span class="string">'CollectOutput'</span>,0,<span class="string">'delimiter'</span>,<span class="string">'\n'</span>);
0091 
0092 A=SXCELL{1};
0093 B={};
0094 
0095 iia=1;
0096 iib=1;
0097 
0098 B{1}=[];
0099 
0100 <span class="keyword">while</span> iia~=length(A)
0101     
0102     
0103     <span class="keyword">if</span> ~strcmp(A{iia}(end),<span class="string">';'</span>)
0104         
0105         B{iib}=[B{iib} A{iia}]; <span class="comment">% catenate until ; is found</span>
0106         
0107     <span class="keyword">else</span>
0108         
0109         B{iib}=[B{iib} A{iia}(1:end-1)]; <span class="comment">% remove ;</span>
0110         
0111         iib=iib+1;
0112         B{iib}=[];
0113     <span class="keyword">end</span>
0114     
0115     iia=iia+1;
0116     
0117 <span class="keyword">end</span>
0118 
0119 SXSTRING=B'; <span class="comment">% still a cell array but every space or new line now is stored as a new cell.</span>
0120 
0121 <span class="comment">% scroll and reshape to divide atributes</span>
0122 tmp={};
0123 
0124 <span class="comment">% for i=1:length(SXSTRING)</span>
0125 <span class="comment">%</span>
0126 <span class="comment">%     waitbar(i/length(SXSTRING));</span>
0127 <span class="comment">%</span>
0128 <span class="comment">%     SXSTRING{i}=strrep(SXSTRING{i},' ',''); % no spaces</span>
0129 <span class="comment">%     SXSTRING{i}=strrep(SXSTRING{i},':=','=');</span>
0130 <span class="comment">%     SXSTRING{i}=strrep(SXSTRING{i},';','');</span>
0131 <span class="comment">%</span>
0132 <span class="comment">%     c=[1 sort([strfind(SXSTRING{i},',') strfind(SXSTRING{i},':')...</span>
0133 <span class="comment">%                      strfind(SXSTRING{i},'=')]) length(SXSTRING{i})];</span>
0134 <span class="comment">%</span>
0135 <span class="comment">%     % split sub strings</span>
0136 <span class="comment">%     for jc=1:length(c)-1</span>
0137 <span class="comment">%         if jc==1</span>
0138 <span class="comment">%             tmp=[tmp SXSTRING{i}(c(jc):c(jc+1))];</span>
0139 <span class="comment">%         else</span>
0140 <span class="comment">%             tmp=[tmp SXSTRING{i}(c(jc)+1:c(jc+1))];</span>
0141 <span class="comment">%         end</span>
0142 <span class="comment">%     end</span>
0143 <span class="comment">%</span>
0144 <span class="comment">% end</span>
0145 <span class="comment">% SXSTRING=tmp;</span>
0146 
0147 
0148 tmp=cellfun(@(a)<a href="#_sub1" class="code" title="subfunction tmp=formatTextMADX(str)">formatTextMADX</a>(a),SXSTRING,<span class="string">'un'</span>,0);
0149 
0150 SXSTRING=[tmp{:}];
0151 
0152 
0153 <span class="comment">%% open .m file to output matlab translated code</span>
0154 
0155 filemacroname=[tempname <span class="string">'.m'</span>];
0156 
0157 mafileout=fopen(filemacroname,<span class="string">'w+'</span>);
0158 mst=[<span class="string">'%% this is a macro that converts to AT the madX lattice: '</span><span class="keyword">...</span>
0159     seqfilemadX <span class="string">'\n%%\n%% Created: '</span> datestr(now)<span class="keyword">...</span>
0160     <span class="string">'\n%%\n%%\n\nglobal GLOBVAL;\nGLOBVAL.E0='</span> num2str(E0)<span class="keyword">...</span>
0161     <span class="string">';\n\n\n'</span>];
0162 def=[<span class="string">'\n\n%%%% DEFINITIONS \n\n'</span>]; <span class="comment">%#ok&lt;*NBRAK&gt;</span>
0163 lines=[<span class="string">'\n\n%%%% LINES \n\n'</span>];
0164 var=[<span class="string">'%%%% VARIABLES \n\n sxt_on=1;'</span>];
0165 formulas=[<span class="string">'\n\n%%%% RELATIONS \n\n'</span>];
0166 
0167 <span class="comment">%% convert to a matlab macro</span>
0168 j=1; <span class="comment">% used in line block counter (element atributes counter)</span>
0169 h=waitbar(0,<span class="string">'Converting: '</span>);
0170 
0171 elemcount=0;
0172 i=1; <span class="comment">% skip header in mad8 file   (element counter)</span>
0173 <span class="keyword">while</span> i&lt;length(SXSTRING)-2
0174     
0175     
0176     <span class="keyword">if</span> SXSTRING{i}(end)==<span class="string">':'</span> <span class="comment">% new element or line</span>
0177         def=[ def <span class="keyword">...</span>
0178             ]; <span class="comment">%#ok&lt;*AGROW&gt; % end line and go to newline add name</span>
0179         SXSTRING{i}(1:end-1)=upper(SXSTRING{i}(1:end-1));
0180         
0181         SXSTRING{i+j}=strrep(SXSTRING{i+j},<span class="string">'MARKER'</span>,<span class="string">'MARKER,'</span>);
0182         SXSTRING{i+j}=strrep(SXSTRING{i+j},<span class="string">'MARKER,,'</span>,<span class="string">'MARKER,'</span>);
0183         SXSTRING{i+j}=strrep(SXSTRING{i+j},<span class="string">'KICKER'</span>,<span class="string">'KICKER,'</span>);
0184         SXSTRING{i+j}=strrep(SXSTRING{i+j},<span class="string">'KICKER,,'</span>,<span class="string">'KICKER,'</span>);
0185         SXSTRING{i+j}=strrep(SXSTRING{i+j},<span class="string">'MONITOR'</span>,<span class="string">'MONITOR,'</span>);
0186         SXSTRING{i+j}=strrep(SXSTRING{i+j},<span class="string">'MONITOR,,'</span>,<span class="string">'MONITOR,'</span>);
0187         
0188         ElementType=SXSTRING{i+j}(1:end-1);
0189         
0190         
0191         <span class="comment">% display status of conversion</span>
0192         waitbar(i/(length(SXSTRING)-2),h,[<span class="string">'Converting: '</span> ElementType]);
0193         
0194         <span class="comment">%  THERING=[THERING ' ' SXSTRING{i+1}];</span>
0195         <span class="comment">%j=2;</span>
0196         nwel=SXSTRING{i+j}(end);
0197         
0198         <span class="keyword">switch</span> ElementType
0199             <span class="keyword">case</span> {<span class="string">'quadrupole'</span>,<span class="string">'QUADRUPOLE'</span>, <span class="string">'QUADRUPO'</span>}
0200                 def=[def <span class="string">'\n'</span>];
0201                 def=[ def <span class="keyword">...</span>
0202                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0203                     <span class="string">'=atquadrupole('''</span><span class="keyword">...</span>
0204                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0205                     <span class="string">''',0,0,''StrMPoleSymplectic4Pass'');\n'</span><span class="keyword">...</span>
0206                     ];
0207                 
0208                 
0209                 elemcount=elemcount+1;
0210                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0211                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),SXSTRING{i+j},SXSTRING{i+j+1});
0212                     
0213                     j=j+1; <span class="comment">%go to new atribute</span>
0214                     nwel=SXSTRING{i+j}(end);
0215                 <span class="keyword">end</span>
0216                 
0217             <span class="keyword">case</span> {<span class="string">'sextupole'</span>,<span class="string">'SEXTUPOLE'</span>}
0218                 def=[def <span class="string">'\n'</span>];
0219                 def=[ def <span class="keyword">...</span>
0220                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0221                     <span class="string">'=atsextupole('''</span><span class="keyword">...</span>
0222                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0223                     <span class="string">''',0,0,''StrMPoleSymplectic4Pass'');\n'</span><span class="keyword">...</span>
0224                     ];
0225                 
0226                 
0227                 elemcount=elemcount+1;
0228                 
0229                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0230                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),SXSTRING{i+j},SXSTRING{i+j+1});
0231                     
0232                     j=j+1; <span class="comment">%go to new atribute</span>
0233                     nwel=SXSTRING{i+j}(end);
0234                 <span class="keyword">end</span>
0235                 def=[ def <span class="keyword">...</span>
0236                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')='</span> SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')*1/2'</span> <span class="string">';\n'</span> <span class="keyword">...</span>
0237                     ];
0238                 
0239             <span class="keyword">case</span> {<span class="string">'rbend'</span>,<span class="string">'RBEND'</span>}
0240                 
0241                 def=[def <span class="string">'\n'</span>];
0242                 
0243                 def=[ def <span class="keyword">...</span>
0244                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0245                     <span class="string">'=atrbend('''</span><span class="keyword">...</span>
0246                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0247                     <span class="string">''',0,0,0,''BndMPoleSymplectic4Pass'');\n'</span><span class="keyword">...</span>
0248                     ];
0249                 
0250                 
0251                 elemcount=elemcount+1;
0252                 
0253                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0254                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),SXSTRING{i+j},SXSTRING{i+j+1});
0255                     
0256                     j=j+1; <span class="comment">%go to new atribute</span>
0257                     nwel=SXSTRING{i+j}(end);
0258                 <span class="keyword">end</span>
0259                 <span class="comment">% bendings are  sector by default. change to rectangular</span>
0260                 def=[ def <span class="keyword">...</span>
0261                     SXSTRING{i}(1:end-1) <span class="string">'.(''EntranceAngle'')='</span> SXSTRING{i}(1:end-1) <span class="string">'.(''EntranceAngle'')+'</span> SXSTRING{i}(1:end-1) <span class="string">'.(''BendingAngle'')/2; \n'</span><span class="keyword">...</span>
0262                     SXSTRING{i}(1:end-1) <span class="string">'.(''ExitAngle'')='</span> SXSTRING{i}(1:end-1) <span class="string">'.(''ExitAngle'')+'</span> SXSTRING{i}(1:end-1) <span class="string">'.(''BendingAngle'')/2; \n'</span><span class="keyword">...</span>
0263                     SXSTRING{i}(1:end-1) <span class="string">'.(''Length'')='</span> SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0264                     <span class="string">'.(''Length'')*('</span> SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0265                     <span class="string">'.(''BendingAngle'')/2)/sin('</span> SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0266                     <span class="string">'.(''BendingAngle'')/2); \n'</span><span class="keyword">...</span>
0267                     SXSTRING{i}(1:end-1) <span class="string">'.(''MaxOrder'')=length('</span> SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB''))-1; \n'</span>];
0268                 
0269             <span class="keyword">case</span> {<span class="string">'sbend'</span>,<span class="string">'SBEND'</span>}
0270                 def=[def <span class="string">'\n'</span>];
0271                 
0272                 def=[ def <span class="keyword">...</span>
0273                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0274                     <span class="string">'=atsbend('</span><span class="keyword">...</span>
0275                     <span class="string">''''</span> SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0276                     <span class="string">''',0,0,0,''BndMPoleSymplectic4Pass'');\n'</span><span class="keyword">...</span>
0277                     ];
0278                 
0279                 elemcount=elemcount+1;
0280                 
0281                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0282                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0283                         SXSTRING{i+j},SXSTRING{i+j+1});
0284                     
0285                     j=j+1; <span class="comment">%go to new atribute</span>
0286                     nwel=SXSTRING{i+j}(end);
0287                 <span class="keyword">end</span>
0288                 
0289                 def=[ def SXSTRING{i}(1:end-1) <span class="string">'.(''MaxOrder'')=length('</span> SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB''))-1; \n'</span>];
0290                 
0291             <span class="keyword">case</span> {<span class="string">'DRIFT'</span>,<span class="string">'drift'</span>}
0292                 def=[def <span class="string">'\n'</span>];
0293                 
0294                 def=[ def <span class="keyword">...</span>
0295                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0296                     <span class="string">'=atdrift('</span><span class="keyword">...</span>
0297                     <span class="string">''''</span> SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0298                     <span class="string">''',0,''DriftPass'');\n'</span><span class="keyword">...</span>
0299                     ];
0300                 
0301                 
0302                 elemcount=elemcount+1;
0303                 
0304                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0305                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0306                         SXSTRING{i+j},SXSTRING{i+j+1});
0307                     
0308                     j=j+1; <span class="comment">%go to new atribute</span>
0309                     nwel=SXSTRING{i+j}(end);
0310                 <span class="keyword">end</span>
0311             <span class="keyword">case</span> {<span class="string">'RFCAVITY'</span>,<span class="string">'rfcavity'</span>}
0312                 def=[def <span class="string">'\n'</span>];
0313                 
0314                 def=[ def <span class="keyword">...</span>
0315                     SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0316                     <span class="string">'=atrfcavity('''</span> SXSTRING{i}(1:end-1)<span class="keyword">...</span>
0317                     <span class="string">''',0,0,0,0,'</span> num2str(E0) <span class="keyword">...</span>
0318                     <span class="string">',''DriftPass'');\n'</span><span class="keyword">...</span>
0319                     ];
0320                 
0321                 elemcount=elemcount+1;
0322                 
0323                 
0324                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0325                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0326                         SXSTRING{i+j},SXSTRING{i+j+1});
0327                     
0328                     j=j+1; <span class="comment">%go to new atribute</span>
0329                     nwel=SXSTRING{i+j}(end);
0330                 <span class="keyword">end</span>
0331             <span class="keyword">case</span> {<span class="string">'MULTIPOLE'</span>,<span class="string">'multipole'</span>}
0332                 <span class="comment">% multipoles should be StrMPoleSymplectic4Pass with short length</span>
0333                 <span class="comment">% to be compatible with MADX</span>
0334                 
0335                 def=[def <span class="string">'\n'</span>];
0336                 
0337                 def=[ def <span class="keyword">...</span>
0338                     SXSTRING{i}(1:end-1) <span class="string">'=atthinmultipole('</span><span class="keyword">...</span>
0339                     <span class="string">''''</span> SXSTRING{i}(1:end-1) <span class="string">''''</span><span class="keyword">...</span>
0340                     <span class="string">',[0 0 0 0],[0 0 0 0],'</span><span class="keyword">...</span>
0341                     <span class="string">'''ThinMPolePass'');\n'</span><span class="keyword">...</span>
0342                     SXSTRING{i}(1:end-1) <span class="string">'.(''Length'')=0; \n'</span><span class="keyword">...</span>
0343                     ];
0344                 
0345                 
0346                 elemcount=elemcount+1;
0347                 <span class="comment">% MADX--&gt;   ocf0: multipole,knl:={ 0, 0, 0,kocf0 };</span>
0348                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0349                     
0350                     
0351                     multipoles=[];
0352                     <span class="keyword">if</span> strcmp(SXSTRING{i+j+1}(1),<span class="string">'{'</span>) <span class="comment">% if open paerntesis found</span>
0353                         multipoles=[multipoles <span class="string">'['</span> SXSTRING{i+j+1}(2:end)];
0354                         k=2;
0355                         <span class="keyword">while</span> ~strcmp(SXSTRING{i+j+k}(end),<span class="string">'}'</span>) &amp;&amp; k&lt;10 <span class="comment">% look for closed parentesis</span>
0356                             multipoles=[multipoles SXSTRING{i+j+k}];
0357                             k=k+1;
0358                         <span class="keyword">end</span>
0359                         multipoles=[multipoles SXSTRING{i+j+k}(1:(end-1)) <span class="string">']'</span>];
0360                         
0361                     <span class="keyword">end</span>
0362                     
0363                     <span class="keyword">if</span> ~isempty(multipoles)
0364                         def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0365                             SXSTRING{i+j},multipoles);
0366                         
0367                     <span class="keyword">else</span>
0368                         def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0369                             SXSTRING{i+j},SXSTRING{i+j+1});
0370                     <span class="keyword">end</span>
0371                     j=j+1; <span class="comment">%go to new atribute</span>
0372                     nwel=SXSTRING{i+j}(end);
0373                     
0374                 <span class="keyword">end</span>
0375                 def=[ def <span class="keyword">...</span>
0376                     SXSTRING{i}(1:end-1) <span class="string">'.(''Class'')=''Multipole''; \n'</span><span class="keyword">...</span><span class="comment">% max order size polynomb -1</span>
0377                     SXSTRING{i}(1:end-1) <span class="string">'.(''MaxOrder'')=numel('</span> <span class="keyword">...</span>
0378                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')'</span> <span class="string">')-1; \n'</span><span class="keyword">...</span><span class="comment">% max order size polynomb -1</span>
0379                     <span class="string">'expansionCoefFixA=1./factorial([1: numel('</span> <span class="keyword">...</span>
0380                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomA''))]-1); \n'</span><span class="keyword">...</span>
0381                     <span class="string">'expansionCoefFixB=1./factorial([1: numel('</span> <span class="keyword">...</span>
0382                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB''))]-1); \n'</span><span class="keyword">...</span>
0383                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')=('</span> <span class="keyword">...</span>
0384                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')'</span> <span class="string">').*expansionCoefFixB; \n'</span><span class="keyword">...</span>
0385                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomA'')=('</span> <span class="keyword">...</span>
0386                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomA'')'</span> <span class="string">').*expansionCoefFixA; \n'</span><span class="keyword">...</span>
0387                     ];
0388                 
0389             <span class="keyword">case</span> {<span class="string">'OCTUPOLE'</span>,<span class="string">'octupole'</span>}
0390                 def=[def <span class="string">'\n'</span>];
0391                 
0392                 def=[ def <span class="keyword">...</span>
0393                     SXSTRING{i}(1:end-1) <span class="string">'=atmultipole('</span><span class="keyword">...</span>
0394                     <span class="string">''''</span> SXSTRING{i}(1:end-1) <span class="string">''''</span><span class="keyword">...</span>
0395                     <span class="string">',0,[0 0 0 0],[0 0 0 0],'</span><span class="keyword">...</span>
0396                     <span class="string">'''StrMPoleSymplectic4Pass'');\n'</span><span class="keyword">...</span>
0397                     ];
0398                 
0399                 
0400                 elemcount=elemcount+1;
0401                 
0402                 
0403                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0404                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0405                         SXSTRING{i+j},SXSTRING{i+j+1});
0406                     
0407                     j=j+1; <span class="comment">%go to new atribute</span>
0408                     nwel=SXSTRING{i+j}(end);
0409                 <span class="keyword">end</span>
0410                 
0411                 <span class="comment">% fix madX-AT multipole coefficents</span>
0412                 def=[ def <span class="keyword">...</span>
0413                     SXSTRING{i}(1:end-1) <span class="string">'.(''Class'')=''Octupole''; \n'</span><span class="keyword">...</span><span class="comment">% max order size polynomb -1</span>
0414                     SXSTRING{i}(1:end-1) <span class="string">'.(''MaxOrder'')=numel('</span> <span class="keyword">...</span>
0415                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')'</span> <span class="string">')-1; \n'</span><span class="keyword">...</span><span class="comment">% max order size polynomb -1</span>
0416                     <span class="string">'expansionCoefFixA=1./factorial([1: numel('</span> <span class="keyword">...</span>
0417                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomA''))]-1); \n'</span><span class="keyword">...</span>
0418                     <span class="string">'expansionCoefFixB=1./factorial([1: numel('</span> <span class="keyword">...</span>
0419                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB''))]-1); \n'</span><span class="keyword">...</span>
0420                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')=('</span> <span class="keyword">...</span><span class="comment">.</span>
0421                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')'</span> <span class="string">').*expansionCoefFixB; \n'</span><span class="keyword">...</span>
0422                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomA'')=('</span> <span class="keyword">...</span>
0423                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomA'')'</span> <span class="string">').*expansionCoefFixA; \n'</span><span class="keyword">...</span>
0424                     ];
0425                 
0426             <span class="keyword">case</span> {<span class="string">'SOLENOID'</span>,<span class="string">'solenoid'</span>}
0427                 def=[def <span class="string">'\n'</span>];
0428                 
0429                 def=[ def <span class="keyword">...</span>
0430                     SXSTRING{i}(1:end-1) <span class="string">'=atsolenoid('</span><span class="keyword">...</span>
0431                     <span class="string">''''</span> SXSTRING{i}(1:end-1) <span class="string">''''</span><span class="keyword">...</span>
0432                     <span class="string">',0,0,'</span><span class="keyword">...</span>
0433                     <span class="string">'''SolenoidLinearPass'');\n'</span><span class="keyword">...</span>
0434                     ];
0435                 
0436                 
0437                 elemcount=elemcount+1;
0438                 
0439                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0440                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0441                         SXSTRING{i+j},SXSTRING{i+j+1});
0442                     
0443                     j=j+1; <span class="comment">%go to new atribute</span>
0444                     nwel=SXSTRING{i+j}(end);
0445                 <span class="keyword">end</span>
0446             <span class="keyword">case</span> {<span class="string">'MARKER'</span>,<span class="string">'marker'</span>,<span class="string">'marke'</span>}
0447                 def=[def <span class="string">'\n'</span>];
0448                 
0449                 def=[ def <span class="keyword">...</span>
0450                     SXSTRING{i}(1:end-1) <span class="string">'=atmarker('</span><span class="keyword">...</span>
0451                     <span class="string">''''</span> SXSTRING{i}(1:end-1) <span class="string">''');\n'</span><span class="keyword">...</span>
0452                     SXSTRING{i}(1:end-1) <span class="string">'.(''Length'')=0; \n'</span><span class="keyword">...</span>
0453                     SXSTRING{i}(1:end-1) <span class="string">'.(''Class'')=''Marker''; \n'</span><span class="keyword">...</span>
0454                     ];
0455                 
0456                 elemcount=elemcount+1;
0457                 
0458                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0459                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0460                         SXSTRING{i+j},SXSTRING{i+j+1});
0461                     
0462                     j=j+1; <span class="comment">%go to new atribute</span>
0463                     nwel=SXSTRING{i+j}(end);
0464                 <span class="keyword">end</span>
0465             <span class="keyword">case</span> {<span class="string">'MATRIX'</span>,<span class="string">'matrix'</span>,<span class="string">'Matrix'</span>}
0466                 def=[def <span class="string">'\n'</span>];
0467                 
0468                 def=[ def <span class="keyword">...</span>
0469                     SXSTRING{i}(1:end-1) <span class="string">'=atM66Tijk('</span><span class="keyword">...</span>
0470                     <span class="string">''''</span> SXSTRING{i}(1:end-1) <span class="string">''');\n'</span><span class="keyword">...</span>
0471                     SXSTRING{i}(1:end-1) <span class="string">'.(''Length'')=0; \n'</span><span class="keyword">...</span>
0472                     SXSTRING{i}(1:end-1) <span class="string">'.(''Tijk'')=zeros(6,6,6); \n'</span><span class="keyword">...</span>
0473                     SXSTRING{i}(1:end-1) <span class="string">'.(''M66'')=eye(6,6); \n'</span><span class="keyword">...</span>
0474                     SXSTRING{i}(1:end-1) <span class="string">'.(''Class'')=''MatrixTijk''; \n'</span><span class="keyword">...</span>
0475                     ];
0476                 
0477                 elemcount=elemcount+1;
0478                 
0479                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0480                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0481                         SXSTRING{i+j},SXSTRING{i+j+1});
0482                     
0483                     j=j+1; <span class="comment">%go to new atribute</span>
0484                     nwel=SXSTRING{i+j}(end);
0485                 <span class="keyword">end</span>
0486             <span class="keyword">case</span> {<span class="string">'Collimator'</span>,<span class="string">'collimator'</span>,<span class="string">'COLLIMATOR'</span>}
0487                 def=[def <span class="string">'\n'</span>];
0488                 
0489                 def=[ def <span class="keyword">...</span>
0490                     SXSTRING{i}(1:end-1) <span class="string">'=atmarker('</span><span class="keyword">...</span>
0491                     <span class="string">''''</span> SXSTRING{i}(1:end-1) <span class="string">''');\n'</span><span class="keyword">...</span>
0492                     SXSTRING{i}(1:end-1) <span class="string">'.(''Length'')=0; \n'</span><span class="keyword">...</span>
0493                     SXSTRING{i}(1:end-1) <span class="string">'.(''Class'')=''Marker''; \n'</span><span class="keyword">...</span>
0494                     ];
0495                 
0496                 elemcount=elemcount+1;
0497                 
0498                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0499                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0500                         SXSTRING{i+j},SXSTRING{i+j+1});
0501                     
0502                     j=j+1; <span class="comment">%go to new atribute</span>
0503                     nwel=SXSTRING{i+j}(end);
0504                 <span class="keyword">end</span>
0505             <span class="keyword">case</span> {<span class="string">'MONITOR'</span>,<span class="string">'monitor'</span>,<span class="string">'monito'</span>}
0506                 def=[def <span class="string">'\n'</span>];
0507                 def=[ def <span class="keyword">...</span>
0508                     SXSTRING{i}(1:end-1) <span class="string">'.(''FamName'')='''</span> SXSTRING{i}(1:end-1) <span class="string">''';\n'</span> <span class="keyword">...</span>
0509                     SXSTRING{i}(1:end-1) <span class="string">'.(''Class'')=''Monitor''; \n'</span><span class="keyword">...</span>
0510                     SXSTRING{i}(1:end-1) <span class="string">'.(''BetaCode'')=''PU''; \n'</span><span class="keyword">...</span>
0511                     SXSTRING{i}(1:end-1) <span class="string">'.(''PassMethod'')=''IdentityPass''; \n'</span><span class="keyword">...</span>
0512                     SXSTRING{i}(1:end-1) <span class="string">'.(''MaxOrder'')=1; \n'</span><span class="keyword">...</span>
0513                     SXSTRING{i}(1:end-1) <span class="string">'.(''NumIntSteps'')=2; \n'</span><span class="keyword">...</span>
0514                     SXSTRING{i}(1:end-1) <span class="string">'.(''Length'')=0; \n'</span><span class="keyword">...</span>
0515                     SXSTRING{i}(1:end-1) <span class="string">'.(''Energy'')='</span> num2str(E0) <span class="string">'; \n'</span><span class="keyword">...</span>
0516                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomB'')=zeros(1,4); \n'</span><span class="keyword">...</span>
0517                     SXSTRING{i}(1:end-1) <span class="string">'.(''PolynomA'')=zeros(1,4); \n'</span><span class="keyword">...</span>
0518                     ];
0519                 elemcount=elemcount+1;
0520                 
0521                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0522                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0523                         SXSTRING{i+j},SXSTRING{i+j+1});
0524                     
0525                     j=j+1; <span class="comment">%go to new atribute</span>
0526                     nwel=SXSTRING{i+j}(end);
0527                 <span class="keyword">end</span>
0528             <span class="keyword">case</span> {<span class="string">'KICKER'</span>,<span class="string">'hkicker'</span>,<span class="string">'vkicker'</span>,<span class="string">'kicker'</span>}
0529                 
0530                 def=[def <span class="string">'\n'</span>];
0531                 def=[ def <span class="keyword">...</span>
0532                     SXSTRING{i}(1:end-1) <span class="string">'=atmultipole('</span><span class="keyword">...</span>
0533                     <span class="string">''''</span> SXSTRING{i}(1:end-1) <span class="string">''''</span><span class="keyword">...</span>
0534                     <span class="string">',0,[0 0 0 0],[0 0 0 0],'</span><span class="keyword">...</span>
0535                     <span class="string">'''StrMPoleSymplectic4Pass'');\n'</span><span class="keyword">...</span>
0536                     ];
0537                 
0538                 def=[ def <span class="keyword">...</span>
0539                     SXSTRING{i}(1:end-1) <span class="string">'.(''MaxOrder'')=1; \n'</span><span class="keyword">...</span>
0540                     SXSTRING{i}(1:end-1) <span class="string">'.(''Energy'')='</span> num2str(E0) <span class="string">'; \n'</span><span class="keyword">...</span>
0541                     ];
0542                 
0543                 
0544                 elemcount=elemcount+1;
0545                 
0546                 <span class="keyword">while</span> nwel~=<span class="string">':'</span> <span class="comment">% loops atributes of this element definition</span>
0547                     def=<a href="ParseAtributesMADX_2_AT.html" class="code" title="function R=ParseAtributesMADX_2_AT(R,elname,var,val)">ParseAtributesMADX_2_AT</a>(def,SXSTRING{i}(1:end-1),<span class="keyword">...</span>
0548                         SXSTRING{i+j},SXSTRING{i+j+1});
0549                     
0550                     j=j+1; <span class="comment">%go to new atribute</span>
0551                     nwel=SXSTRING{i+j}(end);
0552                 <span class="keyword">end</span>
0553             <span class="keyword">case</span> {<span class="string">'CONSTAN'</span>,<span class="string">'constant'</span>}
0554                 <span class="comment">% disp('constant')</span>
0555                 
0556                 var=[var SXSTRING{i}(1:end-1) <span class="string">'='</span> SXSTRING{i+3} <span class="string">'; \n '</span>];
0557                 
0558                 j=j+3;
0559             <span class="keyword">case</span> {<span class="string">'sequence'</span>}
0560                 
0561                 <span class="comment">% next element is the length</span>
0562                 seqname=SXSTRING{i}(1:end-1);
0563                 l=SXSTRING{i+j+2};
0564                 j=j+2+1;
0565                 
0566                 waitbar(i/(length(SXSTRING)-2),h,[<span class="string">'Convert sequence: '</span> seqname <span class="string">' '</span>]);
0567                 
0568                 elname=SXSTRING{i+j};
0569                 <a href="../../../../atmat/at.html" class="code" title="">at</a>=SXSTRING{i+j+1};
0570                 lines=[lines seqname <span class="string">'={'</span>];
0571                 sposstring=[<span class="string">'\n spos=['</span>];
0572                 <span class="comment">%zero=0;</span>
0573                 <span class="comment">%driftcounter=1;</span>
0574                 <span class="keyword">while</span> strcmp(<a href="../../../../atmat/at.html" class="code" title="">at</a>,<span class="string">'at='</span>) &amp;&amp; ~strcmp(elname,<span class="string">'endsequence'</span>)
0575                     
0576                     elname=SXSTRING{i+j};
0577                     <span class="comment">% WARNING if fails here add RETURN after madx</span>
0578                     <span class="comment">% ...</span>
0579                     <span class="comment">% endsequence;</span>
0580                     <span class="comment">% RETURN</span>
0581                     <span class="comment">% -----eof------</span>
0582                     
0583                     <span class="keyword">if</span> ~strcmp(elname,<span class="string">'endsequence'</span>)&amp;&amp; ~isempty(elname)
0584                         elname=strrep(elname,<span class="string">','</span>,<span class="string">''</span>);
0585                         <a href="../../../../atmat/at.html" class="code" title="">at</a>=SXSTRING{i+j+1};
0586                         spos=SXSTRING{i+j+2};
0587                         
0588                         lines=[lines upper(elname) <span class="string">';...\n'</span>];
0589                         sposstring=[sposstring <span class="string">',...\n '</span> num2str(spos)];
0590                         
0591                         j=j+3;
0592                     <span class="keyword">else</span>
0593                         j=j+1;
0594                     <span class="keyword">end</span>
0595                 <span class="keyword">end</span>
0596                 lines=[lines <span class="string">'};\n'</span>];
0597                 sposstring=[sposstring <span class="string">'];\n'</span>];
0598                 sposstring(10)=[]; <span class="comment">% remove extra comma</span>
0599                 <span class="comment">% call function that builds sequence from list of elements</span>
0600                 <span class="comment">% and total length of sequence</span>
0601                 lines=[lines sposstring <span class="string">'\n %% BUILD LATTICE \n'</span><span class="keyword">...</span>
0602                     seqname <span class="string">'=buildATLattice('</span> seqname <span class="string">',spos,'</span> l <span class="string">');\n'</span><span class="keyword">...</span>
0603                     <span class="string">'ind=atgetcells('</span> seqname <span class="string">',''Class'',''Drift'',''Bend'',''Quadrupole'',''Sextupole'',''Multipole'');\n'</span><span class="keyword">...</span>
0604                     seqname <span class="string">'=atsetfieldvalues('</span> seqname <span class="string">',ind,''NumIntSteps'',20);\n'</span><span class="keyword">...</span>
0605                     <span class="string">'ind=atgetcells('</span> seqname <span class="string">',''PolynomB'');\n'</span><span class="keyword">...</span>
0606                     <span class="string">'PbL=cellfun(@(a)length(a.PolynomB),'</span> seqname <span class="string">'(ind));\n'</span><span class="keyword">...</span>
0607                     seqname <span class="string">'=atsetfieldvalues('</span> seqname <span class="string">',ind,''MaxOrder'',PbL-1);\n'</span><span class="keyword">...</span>
0608                     <span class="string">'ind = find(atgetcells('</span> seqname <span class="string">',''Tilt''))'';\n'</span><span class="keyword">...</span>
0609                     <span class="string">'T=atgetfieldvalues('</span> seqname <span class="string">',ind,''Tilt'');\n'</span><span class="keyword">...</span>
0610                     seqname <span class="string">'= atsettilt('</span> seqname <span class="string">',ind,T);\n'</span><span class="keyword">...</span>
0611                     <span class="keyword">...</span><span class="comment"> seqname '_red=atreduce(' seqname ');\n'...</span>
0612                     <span class="keyword">...</span><span class="comment"> seqname '_FF=FringeSwitch(' seqname ',1);\n'...</span>
0613                     ];
0614                 
0615             <span class="keyword">otherwise</span>
0616                 disp([<span class="string">'Unknown element type: '</span> ElementType])
0617         <span class="keyword">end</span>
0618         
0619         
0620         
0621     <span class="keyword">else</span> <span class="comment">% variable declaration??</span>
0622         <span class="keyword">if</span> SXSTRING{i}(1)~=<span class="string">'!'</span>;
0623             
0624             <span class="comment">% in mad8 declaring a variable before using it is not compulsary.</span>
0625             <span class="comment">% check that all definitions are at the begining.</span>
0626             <span class="comment">%if sum(ismember('ABCDFGHILMNOPQRSTUVZWYK',SXSTRING{i+2}))&gt;0</span>
0627             <span class="keyword">if</span> sum(ismember(<span class="string">'()/*+-'</span>,SXSTRING{i+1}))&gt;0
0628                 <span class="comment">% if letters (but E for exponential) then it is a formula</span>
0629                 formulas=[formulas SXSTRING{i} <span class="string">' '</span> SXSTRING{i+1} <span class="string">'; \n '</span>];
0630             <span class="keyword">else</span>
0631                 var=[var SXSTRING{i} <span class="string">' '</span> SXSTRING{i+1} <span class="string">'; \n '</span>];
0632             <span class="keyword">end</span>
0633             j=2;
0634         <span class="keyword">end</span>
0635     <span class="keyword">end</span> <span class="comment">% if new element</span>
0636     
0637     i=i+j;
0638     j=1;
0639     
0640 <span class="keyword">end</span>
0641 
0642 
0643 
0644 <span class="comment">%% save close and exit</span>
0645 
0646 macroconvertmadXAT=strrep([mst var formulas def lines],<span class="string">';;'</span>,<span class="string">';'</span>);
0647 fprintf(mafileout,macroconvertmadXAT);
0648 
0649 fclose(<span class="string">'all'</span>);
0650 close(h);
0651 
0652 <span class="comment">%% clean workspace</span>
0653 clear macroconvertmadXAT formulas def lines var mst
0654 clear SXSTRING i j SXCELL elemcount ElementType elname
0655 
0656 <span class="comment">%% run macro file and save workspace.</span>
0657 
0658 [~,seqfilemadX]=fileparts(seqfilemadX);
0659 
0660 <span class="keyword">try</span> <span class="comment">% try to run the macro generated</span>
0661     <span class="comment">%%%!!!!! THIS COMAND MAY FAIL! CHECK THE ORDER OF THE DECLARATIONS IN MADX!</span>
0662     run(filemacroname)
0663     
0664     <span class="keyword">if</span> nargin&lt;3
0665         save([seqfilemadX <span class="string">'_AT_LATTICE'</span>]);
0666     <span class="keyword">else</span>
0667         save(outfilename);
0668     <span class="keyword">end</span>
0669     
0670     <span class="comment">%delete(filemacroname);</span>
0671     fileoutname=[seqfilemadX <span class="string">'_AT_macro.m'</span>];
0672     
0673     movefile(filemacroname,fileoutname);
0674     
0675     
0676 <span class="keyword">catch</span> <span class="comment">%#ok&lt;CTCH&gt;</span>
0677     
0678     fileoutname=[seqfilemadX <span class="string">'_AT_macro.m'</span>];
0679     
0680     movefile(filemacroname,fileoutname);
0681     
0682     disp([<span class="string">'saved macro in : '</span> fileoutname]);
0683     
0684     error([<span class="string">'could not run the macro file.'</span><span class="keyword">...</span>
0685         <span class="string">' It is now in your current directory.'</span><span class="keyword">...</span>
0686         <span class="string">' Please check the order of the definitions'</span><span class="keyword">...</span>
0687         <span class="string">' Please check the multipole definitions in .seq have at least 2 elements m: multipole,knl:={ 0.0, 0.0 };'</span>]);
0688 <span class="keyword">end</span>
0689 
0690 fclose(<span class="string">'all'</span>);
0691 
0692 <span class="keyword">return</span>
0693 
0694 
0695 <a name="_sub1" href="#_subfunctions" class="code">function tmp=formatTextMADX(str)</a>
0696 
0697 tmp={};
0698 
0699 str=strrep(str,<span class="string">' '</span>,<span class="string">''</span>); <span class="comment">% no spaces</span>
0700 str=strrep(str,<span class="string">':='</span>,<span class="string">'='</span>);
0701 str=strrep(str,<span class="string">';'</span>,<span class="string">''</span>);
0702 
0703 c=[1 sort([strfind(str,<span class="string">','</span>) strfind(str,<span class="string">':'</span>)<span class="keyword">...</span>
0704     strfind(str,<span class="string">'='</span>)]) length(str)];
0705 
0706 <span class="comment">% split in substrings</span>
0707 <span class="keyword">for</span> jc=1:length(c)-1
0708     <span class="keyword">if</span> jc==1
0709         tmp{jc}=str(c(jc):c(jc+1));
0710     <span class="keyword">else</span>
0711         tmp{jc}=str(c(jc)+1:c(jc+1));
0712     <span class="keyword">end</span>
0713 <span class="keyword">end</span>
0714 
0715 <span class="keyword">return</span></pre></div>
<hr><address>Generated on Sat 03-Mar-2018 19:26:17 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>