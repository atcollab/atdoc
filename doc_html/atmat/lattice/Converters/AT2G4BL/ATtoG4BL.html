<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ATtoG4BL</title>
  <meta name="keywords" content="ATtoG4BL">
  <meta name="description" content="function [outtext]=ATtoG4BL(P_0,particle,folder)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>

<!-- ../../../menu.html atmat --><!-- ../../menu.html lattice --><!-- ../menu.html Converters --><!-- menu.html AT2G4BL --><h1>ATtoG4BL
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>function [outtext]=ATtoG4BL(P_0,particle,folder)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../../../atcollab.png)"><pre class="comment"> function [outtext]=ATtoG4BL(P_0,particle,folder)
 tansform AT structure into G4BL input file.
 
 Simone Maria Liuzzo PhD@ESRF 11-oct-2012</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../../../atcollab.png)">
This function calls:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
<li><a href="../../../../atmat/atphysics/findspos.html" class="code" title="function spos = findspos(line,refpts)">findspos</a>	FINDSPOS returns longitudinal positions of accelerator lattice elements.</li><li><a href="../../../../atmat/lattice/findcells.html" class="code" title="function index = findcells(CELLARRAY, field, varargin)">findcells</a>	FINDCELLS performs a search on MATLAB cell arrays of structures</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../../matlabicon.gif)">
</ul>
</div>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../../up.png"></a></h2>
<div class="fragment" style="background-image:url(../../../../atcollab.png)"><pre>0001 <span class="comment">% function [outtext]=ATtoG4BL(P_0,particle,folder)</span>
0002 <span class="comment">% tansform AT structure into G4BL input file.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Simone Maria Liuzzo PhD@ESRF 11-oct-2012</span>
0005 
0006 <span class="comment">%load ../../../routines/OptimizationsN4/StartVal0.mat</span>
0007 <span class="comment">%load ../../../routines/OptimizedipolesV173/bendoptStartV173.mat</span>
0008 <span class="comment">%arc=LOW_EMIT_RING;</span>
0009 <span class="comment">%arc=mergedoublesDipole(arc,'BPI5');</span>
0010 <span class="comment">%arc=mergedoublesDipole(arc,'BPI6');</span>
0011 <span class="comment">%E0=arc{1}.('Energy');</span>
0012 <span class="comment">%multbend=2;</span>
0013 <span class="comment">%nameG4bllat='G4blnewlat';</span>
0014 <span class="comment">% arc=LOW_EMIT_RING;</span>
0015 <span class="comment">% E0=6.039*1e9;</span>
0016 
0017   load ../../../LATTICES/perfmach78.mat
0018   arc=THERING;<span class="comment">%(1:51);</span>
0019   multbend=0;
0020   nameG4bllat=<span class="string">'ESRFlat'</span>;
0021 
0022  sector=1;
0023 <span class="comment">% E0=6.039*1e9;</span>
0024 
0025 format longe
0026 
0027 StepLength=10; <span class="comment">% [mm] default is 10mm</span>
0028 
0029 Nevents=1; <span class="comment">% e+ events and e- events.</span>
0030 disp([<span class="string">'writing G4BL file to simulate: '</span> num2str(Nevents) <span class="string">' e-'</span>])
0031 det=0;
0032 SR=0;
0033 RINGFLAG=1;
0034 fringON=0;
0035 
0036 TotLength=<a href="../../../../atmat/atphysics/findspos.html" class="code" title="function spos = findspos(line,refpts)">findspos</a>(arc,length(arc)+1); <span class="comment">%[mm]</span>
0037 
0038 beamstart=0;
0039 
0040 <span class="comment">% beams shapes</span>
0041 
0042 <span class="comment">% diversi da zero muore!!! sestupoli??? KL? BRHO?</span>
0043 sX=1*1e-3; <span class="comment">%[mm]</span>
0044 sY=1*1e-3; <span class="comment">%[mm]</span>
0045 sXp=0*1e-6; <span class="comment">%[rad]</span>
0046 sYp=0*1e-6; <span class="comment">%[rad]</span>
0047 
0048 killval=1;
0049 
0050 
0051 P_0=sqrt((E0/1e9)^2-(0.511/1e6)^2); <span class="comment">% transform in momentum</span>
0052 particle=<span class="string">'e-'</span>;
0053 
0054 sxt=1;
0055 quadH=-1;  <span class="comment">% e- want - sign</span>
0056 
0057 Brho=3.3356409519815205*P_0; <span class="comment">% positron and opposite rotation</span>
0058 
0059 
0060 bigmondo=[<span class="keyword">...</span>
0061     <span class="keyword">...</span><span class="comment">'box mondo height=10000 width=3000000 length=3000000 material=Vacuum \n'...</span>
0062     ];
0063 
0064 ShynRadstarter=[
0065     <span class="string">'#### no net displacement beam generator for radiation.\n'</span><span class="keyword">...</span>
0066     <span class="string">'genericbend B1  fieldLength=2 fieldWidth=300  fieldHeight=300  ironLength=2 ironWidth=330  ironHeight=330  fringe=0   By=0.1 ironColor=0.5,.0,.0 kill=1 \n'</span><span class="keyword">...</span>
0067     <span class="string">'genericbend B2  fieldLength=1 fieldWidth=300  fieldHeight=300  ironLength=1 ironWidth=330  ironHeight=330  fringe=0   By=-0.1 ironColor=1,.0,.0 kill=1 \n'</span><span class="keyword">...</span>
0068     <span class="string">'genericbend B3  fieldLength=1 fieldWidth=300  fieldHeight=300  ironLength=1 ironWidth=330  ironHeight=330  fringe=0   By=-0.1 ironColor=0.5,.0,.0 kill=1 \n'</span><span class="keyword">...</span>
0069     <span class="string">'genericbend B4  fieldLength=1 fieldWidth=300  fieldHeight=300  ironLength=1 ironWidth=330  ironHeight=330  fringe=0   By=0.1 ironColor=1,.0,.0 kill=1\n'</span><span class="keyword">...</span>
0070     <span class="string">'\n'</span><span class="keyword">...</span>
0071     <span class="string">'place B1 z=0\n'</span><span class="keyword">...</span>
0072     <span class="string">'place B2 z=1.5\n'</span><span class="keyword">...</span>
0073     <span class="string">'place B3 z=2.5\n'</span><span class="keyword">...</span>
0074     <span class="string">'place B4 z=3.5\n'</span><span class="keyword">...</span>
0075     ];
0076 
0077 <span class="comment">% beam parameters</span>
0078 posbeam=[ <span class="string">' beam gaussian particle='</span> particle <span class="keyword">...</span>
0079     <span class="string">' beamZ='</span> num2str(beamstart) <span class="keyword">...</span>
0080     <span class="string">' beamX='</span> num2str(+0*1.532845188e-07,15) <span class="keyword">...</span>
0081     <span class="string">' beamXp='</span> num2str(+0*1.683548689e-07,15) <span class="keyword">...</span>
0082     <span class="string">' rotation=Y'</span> num2str(0*180)<span class="keyword">...</span><span class="comment"> rotate to head back</span>
0083     <span class="string">'  nEvents='</span> num2str(Nevents) <span class="string">' '</span><span class="keyword">...</span><span class="comment"> % nEvents=10</span>
0084     <span class="string">'    sigmaX='</span> num2str(sX,15) <span class="keyword">...</span>
0085     <span class="string">' sigmaY='</span> num2str(sY,15)<span class="keyword">...</span>
0086     <span class="string">' sigmaXp='</span> num2str(sXp,15)<span class="keyword">...</span>
0087     <span class="string">' sigmaYp='</span> num2str(sYp,15) <span class="string">' '</span><span class="keyword">...</span>
0088     <span class="string">'    meanMomentum='</span> num2str(P_0*1000,15) <span class="string">' sigmaP=0'</span><span class="keyword">...</span>
0089     <span class="string">' meanT=0 sigmaT=0 \n'</span><span class="keyword">...</span>
0090     <span class="string">'trackcolor reference=1,1,1 \n'</span><span class="keyword">...</span>
0091     ShynRadstarter<span class="keyword">...</span>
0092     ];
0093 
0094 head=[<span class="string">'physics QGSP synchrotronRadiation='</span> num2str(SR) <span class="string">'\n'</span><span class="keyword">...</span>
0095     <span class="string">'start x=0 y=0 z='</span> num2str(beamstart) <span class="string">' radiusCut=0.001 ring='</span> num2str(RINGFLAG) <span class="string">'\n'</span><span class="keyword">...</span>
0096     <span class="string">'reference particle='</span> particle <span class="string">' referenceMomentum='</span> num2str(P_0*1000,15) <span class="string">' noEloss=1'</span><span class="keyword">...</span>
0097     <span class="string">' beamXp=0 beamYp=0 '</span><span class="keyword">...</span>
0098     <span class="string">' tuneMomentum='</span> num2str(P_0,15) <span class="string">'\n'</span><span class="keyword">...</span>
0099     <span class="string">'box BeamVis width=200.0 height=200.0 length=0.1 material=Vacuum color=1,0,0 kill=1 \n'</span><span class="keyword">...</span>
0100     <span class="string">'trace nTrace='</span> num2str(2*Nevents) <span class="string">' oneNTuple=1 format=root \n'</span><span class="keyword">...</span><span class="comment">ascii</span>
0101     <span class="string">' param eventTimeLimit=60*8\n'</span><span class="keyword">...</span><span class="comment"> %  8 minutes maximum time for one simulation</span>
0102     <span class="string">' trackcuts keep=e+,e-,gamma maxTime=1000000*10\n'</span> <span class="keyword">...</span><span class="comment"> %ns --&gt; 4micros</span>
0103     ];
0104 <span class="comment">% x damping time= 0.26700741E-01 =&gt; 15% =~ 40ms = 40*10^6 ns</span>
0105 
0106 
0107 defQ= [<span class="string">'virtualdetector Det radius=10.0 length='</span> num2str(2*StepLength)<span class="keyword">...</span>
0108     <span class="string">' color=0,.2,.0 referenceParticle=1 format=rootExtended\n'</span>];
0109 defS=<span class="string">''</span>;
0110 defB=<span class="string">''</span>;
0111 ord=1;
0112 plac={};
0113 defined={};
0114 d=1;
0115 
0116 
0117 quadr=unique([<a href="../../../../atmat/lattice/findcells.html" class="code" title="function index = findcells(CELLARRAY, field, varargin)">findcells</a>(arc,<span class="string">'Class'</span>,<span class="string">'Quadrupole'</span>) <a href="../../../../atmat/lattice/findcells.html" class="code" title="function index = findcells(CELLARRAY, field, varargin)">findcells</a>(arc,<span class="string">'BetaCode'</span>,<span class="string">'QP'</span>) ]);
0118 sextu=unique([<a href="../../../../atmat/lattice/findcells.html" class="code" title="function index = findcells(CELLARRAY, field, varargin)">findcells</a>(arc,<span class="string">'Class'</span>,<span class="string">'Sextupole'</span>) <a href="../../../../atmat/lattice/findcells.html" class="code" title="function index = findcells(CELLARRAY, field, varargin)">findcells</a>(arc,<span class="string">'BetaCode'</span>,<span class="string">'SX'</span>) ]);
0119 dipol=unique([<a href="../../../../atmat/lattice/findcells.html" class="code" title="function index = findcells(CELLARRAY, field, varargin)">findcells</a>(arc,<span class="string">'Class'</span>,<span class="string">'Dipole'</span>) <a href="../../../../atmat/lattice/findcells.html" class="code" title="function index = findcells(CELLARRAY, field, varargin)">findcells</a>(arc,<span class="string">'BetaCode'</span>,<span class="string">'DI'</span>) ]);
0120 octup=unique([<a href="../../../../atmat/lattice/findcells.html" class="code" title="function index = findcells(CELLARRAY, field, varargin)">findcells</a>(arc,<span class="string">'Class'</span>,<span class="string">'Octupole'</span>) <a href="../../../../atmat/lattice/findcells.html" class="code" title="function index = findcells(CELLARRAY, field, varargin)">findcells</a>(arc,<span class="string">'BetaCode'</span>,<span class="string">'OC'</span>) ]);
0121 
0122 <span class="keyword">for</span> i=1:length(quadr)
0123     <span class="comment">%genericquad QDpi fieldLength=280 apertureRadius=101.5 ironRadius=381 \</span>
0124     <span class="comment">%    ironLength=250 ironColor=0.6,.0,.6 kill=' num2str(killval) ' gradient=$KQDpi</span>
0125     <span class="comment">%</span>
0126     S=<a href="../../../../atmat/atphysics/findspos.html" class="code" title="function spos = findspos(line,refpts)">findspos</a>(arc,quadr(i))+arc{quadr(i)}.(<span class="string">'Length'</span>)/2;
0127     N=arc{quadr(i)}.(<span class="string">'FamName'</span>);
0128     L=arc{quadr(i)}.(<span class="string">'Length'</span>);
0129     K=arc{quadr(i)}.(<span class="string">'PolynomB'</span>)(2);
0130     
0131     <span class="keyword">if</span> sum(strcmp(N,defined))==0;
0132         inrad=60; <span class="comment">% quarupole size</span>
0133         outrad=70;
0134         
0135         
0136         defQ=[ defQ <span class="keyword">...</span>
0137             <span class="string">' genericquad '</span> N <span class="string">' '</span><span class="keyword">...</span>
0138             <span class="string">' fieldLength='</span> num2str(L*1000,15) <span class="keyword">...</span><span class="comment"> % mm</span>
0139             <span class="string">' apertureRadius='</span> num2str(inrad,15) <span class="string">' '</span><span class="keyword">...</span>
0140             <span class="string">' ironRadius='</span> num2str(outrad,15) <span class="string">' '</span><span class="keyword">...</span>
0141             <span class="string">' ironLength='</span> num2str(L*1000,15) <span class="string">' '</span><span class="keyword">...</span>
0142             <span class="string">' ironColor=0/255,191/255,255/255 kill='</span> num2str(killval) <span class="string">' '</span><span class="keyword">...</span>
0143             <span class="string">' fringe='</span> num2str(0*fringON) <span class="keyword">...</span>
0144             <span class="string">' gradient='</span> num2str(quadH*K*Brho,15) <span class="string">' '</span><span class="keyword">...</span><span class="comment">  K</span>
0145             <span class="string">' maxStep='</span> num2str(StepLength/2)  <span class="keyword">...</span>
0146             <span class="string">'\n'</span>]; <span class="comment">%#ok&lt;*AGROW&gt;</span>
0147         
0148         <span class="comment">% add to already defined</span>
0149         defined{d}=N;
0150         d=d+1;
0151     <span class="keyword">end</span>
0152     
0153     <span class="keyword">if</span> (ord/2-floor(ord/2))==(det-1) <span class="comment">% set 0 to place a detector in every quadrupole.</span>
0154         plac{ord}=[<span class="string">'place '</span> N <span class="string">' parent=  z='</span> num2str(S*1000,15)<span class="keyword">...</span>
0155             <span class="string">' coordinates=centerline'</span><span class="keyword">...</span>
0156             <span class="string">'\n'</span><span class="keyword">...</span>
0157             <span class="string">'place '</span> <span class="string">'Det'</span> <span class="keyword">...</span>
0158             <span class="string">' rename=DET# '</span><span class="keyword">...</span>
0159             <span class="string">' parent=  z='</span> num2str((S)*1000)<span class="keyword">...</span>
0160             <span class="string">' coordinates=centerline '</span><span class="keyword">...</span>
0161             <span class="string">'\n'</span>]; <span class="comment">%#ok&lt;*SAGROW&gt;</span>
0162     <span class="keyword">else</span>
0163         plac{ord}=[<span class="string">'place '</span> N <span class="string">' parent=  z='</span> num2str(S*1000,15)<span class="keyword">...</span>
0164             <span class="string">' coordinates=centerline'</span><span class="keyword">...</span>
0165             <span class="string">'\n'</span>]; <span class="comment">%#ok&lt;*SAGROW&gt;</span>
0166     <span class="keyword">end</span>
0167     
0168     ord=ord+1;
0169 <span class="keyword">end</span>
0170 
0171 <span class="keyword">for</span> i=1:length(sextu)
0172     <span class="comment">%multipole SF1 fieldLength=150 apertureRadius=101.5 ironRadius=381 \</span>
0173     <span class="comment">%    ironLength=140 ironColor=0,.6,.6 kill=' num2str(killval) ' sextupole=$KSF1</span>
0174     S=<a href="../../../../atmat/atphysics/findspos.html" class="code" title="function spos = findspos(line,refpts)">findspos</a>(arc,sextu(i))+arc{sextu(i)}.(<span class="string">'Length'</span>)/2;
0175     N=arc{sextu(i)}.(<span class="string">'FamName'</span>);
0176     L=arc{sextu(i)}.(<span class="string">'Length'</span>);
0177     <span class="comment">%Ord=arc{sextu(i)}.('MaxOrder');</span>
0178     K=2*arc{sextu(i)}.(<span class="string">'PolynomB'</span>)(3);
0179     
0180     <span class="keyword">if</span> sum(strcmp(N,defined))==0;
0181         inrad=60;
0182         outrad=70;
0183         
0184         
0185         defS=[ defS <span class="keyword">...</span>
0186             <span class="string">' multipole '</span> N <span class="string">' '</span><span class="keyword">...</span>
0187             <span class="string">' fieldLength='</span> num2str(L*1000-1e6,15) <span class="keyword">...</span><span class="comment"> % mm</span>
0188             <span class="string">' apertureRadius='</span> num2str(inrad,15) <span class="string">' '</span><span class="keyword">...</span>
0189             <span class="string">' ironRadius='</span> num2str(outrad,15) <span class="string">' '</span><span class="keyword">...</span>
0190             <span class="string">' ironLength='</span> num2str(L*1000,15) <span class="string">' '</span><span class="keyword">...</span>
0191             <span class="string">' ironColor=173/255,255/255,47/255 kill='</span> num2str(killval) <span class="string">' '</span><span class="keyword">...</span>
0192             <span class="string">' fringe='</span> num2str(0*fringON) <span class="keyword">...</span>
0193             <span class="string">' maxStep='</span> num2str(StepLength/2)  <span class="keyword">...</span>
0194             <span class="string">' sextupole='</span> num2str(sxt*K*Brho,15) <span class="string">' '</span><span class="keyword">...</span><span class="comment"> K2</span>
0195             <span class="string">'\n'</span>];
0196         <span class="comment">% add to already defined</span>
0197         defined{d}=N;
0198         d=d+1;
0199     <span class="keyword">end</span>
0200     
0201     
0202     plac{ord}=[<span class="string">'place '</span> N <span class="string">' parent=  z='</span> num2str(S*1000,15)<span class="keyword">...</span>
0203         <span class="string">' coordinates=centerline '</span><span class="keyword">...</span>
0204         <span class="string">'\n'</span>]; <span class="comment">%#ok&lt;*SAGROW&gt;</span>
0205     ord=ord+1;
0206     
0207 <span class="keyword">end</span>
0208 
0209 totA=0;
0210 <span class="keyword">for</span> i=1:length(dipol)
0211     
0212     <span class="comment">%genericbend BHer fieldWidth=1660 fieldHeight=200 fieldLength=5400 \</span>
0213     <span class="comment">%    ironColor=1,0,0 ironWidth=1828 ironHeight=1320 ironLength=5000 \</span>
0214     <span class="comment">% kill=' num2str(killval) ' By=0.2778157677856496</span>
0215     <span class="comment">%tune B1 z0=100 z1=3000 initial=-0.6500 step=0.01 expr=Px1/Pz1 \</span>
0216     <span class="comment">%tolerance=0.000001</span>
0217     <span class="comment">%genericbend B fieldWidth=500 fieldHeight=500 fieldLength=500 \</span>
0218     <span class="comment">%ironWidth=800 ironHeight=800 ironLength=500 \</span>
0219     <span class="comment">%fieldMaterial=Vacuum place B z=2000 rename=B1 rotation=Y15 By=B1</span>
0220     
0221     S=<a href="../../../../atmat/atphysics/findspos.html" class="code" title="function spos = findspos(line,refpts)">findspos</a>(arc,dipol(i))+arc{dipol(i)}.(<span class="string">'Length'</span>)/2;
0222     N=arc{dipol(i)}.(<span class="string">'FamName'</span>);
0223     L=arc{dipol(i)}.(<span class="string">'Length'</span>);
0224     <span class="comment">%Ord=arc{sextu(i)}.('MaxOrder');</span>
0225     A=arc{dipol(i)}.(<span class="string">'BendingAngle'</span>);
0226     K=quadH*arc{dipol(i)}.(<span class="string">'PolynomB'</span>)(2);
0227 
0228     tmpmultibend=multbend;
0229     <span class="keyword">if</span> K==0
0230         multbend=0;
0231     <span class="keyword">end</span>
0232     
0233     <span class="keyword">if</span> multbend==0
0234         split=1;
0235     <span class="keyword">else</span>
0236         split=1; <span class="comment">%make 'split' parts of a single magnet</span>
0237     <span class="keyword">end</span>
0238     L=L/split;
0239     A=A/split;
0240     K=K/split;
0241     totA=totA+A;
0242     
0243     <span class="keyword">if</span> sum(strcmp(N,defined))==0 <span class="comment">% if not defined, define.</span>
0244         Fw=240*1.0;
0245         Fh=70;
0246         Iw=10+Fw;
0247         Ih=30+Fh;
0248         
0249         defB=[ defB <span class="keyword">...</span>
0250             <span class="string">'\n param B'</span> num2str(i) N <span class="string">'='</span> num2str(-Brho*A/L,15) <span class="string">'\n'</span><span class="keyword">...</span>
0251             ];
0252         <span class="keyword">if</span> multbend==0
0253             <span class="keyword">if</span> sector==0
0254                 defB=[ defB <span class="keyword">...</span>
0255                     <span class="string">'genericbend '</span> N <span class="string">' '</span><span class="keyword">...</span>
0256                     <span class="string">' fieldLength='</span> num2str(L*1000/split,15) <span class="keyword">...</span><span class="comment"> % mm</span>
0257                     <span class="string">' fieldWidth='</span> num2str(Fw,15) <span class="string">' '</span><span class="keyword">...</span>
0258                     <span class="string">' fieldHeight='</span> num2str(Fh,15) <span class="string">' '</span><span class="keyword">...</span>
0259                     <span class="string">' ironLength='</span> num2str(L*1*1000/split,15) <span class="keyword">...</span><span class="comment"> % mm</span>
0260                     <span class="string">' ironWidth='</span> num2str(Iw,15) <span class="string">' '</span><span class="keyword">...</span>
0261                     <span class="string">' ironHeight='</span> num2str(Ih,15) <span class="string">' '</span><span class="keyword">...</span><span class="comment">' fringe=' num2str(fringON) ...</span>
0262                     <span class="string">' maxStep='</span> num2str(StepLength)  <span class="keyword">...</span>
0263                     <span class="string">' By='</span> num2str(Brho*A/L,15)<span class="keyword">...</span><span class="comment">' fieldColor=0.5,.1,.0 '...' By=$B' num2str(i) A ...</span>
0264                     <span class="string">' ironColor=1,.0,.0 kill='</span> num2str(killval) <span class="string">' '</span><span class="keyword">...</span>
0265                     <span class="string">'\n'</span><span class="keyword">...</span>
0266                     ];
0267                 
0268             <span class="keyword">elseif</span> sector==1
0269                 
0270                 defB=[ defB <span class="keyword">...</span>
0271                     <span class="string">'idealsectorbend '</span> N <span class="string">' '</span><span class="keyword">...</span>
0272                     <span class="string">' fieldCenterRadius='</span> num2str((L/A)*1000,15) <span class="string">' '</span><span class="keyword">...</span>
0273                     <span class="string">' fieldOuterRadius='</span> num2str((L/A)*1000+250,15) <span class="string">' '</span><span class="keyword">...</span>
0274                     <span class="string">' fieldInnerRadius='</span> num2str((L/A)*1000-250,15) <span class="string">' '</span><span class="keyword">...</span>
0275                     <span class="string">' fieldHeight='</span> num2str(Fh,15) <span class="string">' '</span><span class="keyword">...</span>
0276                     <span class="string">' ironOuterRadius='</span> num2str((L/A)*1000+270,15) <span class="keyword">...</span><span class="comment"> % mm</span>
0277                     <span class="string">' ironInnerRadius='</span> num2str((L/A)*1000-270,15) <span class="string">' '</span><span class="keyword">...</span>
0278                     <span class="string">' ironHeight='</span> num2str(Ih,15) <span class="string">' '</span><span class="keyword">...</span>
0279                     <span class="string">' maxStep='</span> num2str(StepLength)  <span class="keyword">...</span><span class="comment">' fringe=' num2str(fringON) ...</span>
0280                     <span class="string">' angle='</span> num2str(A*180/pi,15)<span class="keyword">...</span><span class="comment">' fieldColor=0.5,.1,.0 '...' By=$B' num2str(i) A ...</span>
0281                     <span class="string">' By='</span> num2str(Brho*A/L,15)<span class="keyword">...</span>
0282                     <span class="string">' ironColor=1,.0,.0 kill='</span> num2str(killval) <span class="string">' '</span><span class="keyword">...</span>
0283                     <span class="string">'\n'</span><span class="keyword">...</span>
0284                     ];
0285             <span class="keyword">end</span>
0286             
0287         <span class="keyword">elseif</span> multbend==1
0288              <span class="comment">% multipole bend-quadrupole</span>
0289             inrad=60;
0290             outrad=70;
0291             
0292             L=L * (2*sin(A/2))/A;  <span class="comment">% Length of sector arc to length of rectangular element</span>
0293             
0294             <span class="comment">% define 1 slice</span>
0295             defB=[ defB <span class="keyword">...</span>
0296                 <span class="string">'multipole '</span> N <span class="string">' '</span><span class="keyword">...</span>
0297                 <span class="string">' fieldLength='</span> num2str(L*1000,15) <span class="keyword">...</span><span class="comment"> % mm</span>
0298                 <span class="string">' ironLength='</span> num2str(L*1000,15) <span class="keyword">...</span><span class="comment"> % mm</span>
0299                 <span class="string">' ironRadius='</span> num2str(outrad,15) <span class="keyword">...</span><span class="comment"> % mm</span>
0300                 <span class="string">' apertureRadius='</span> num2str(inrad,15) <span class="string">' '</span><span class="keyword">...</span>
0301                 <span class="string">' fringe='</span> num2str(0*fringON) <span class="keyword">...</span>
0302                 <span class="string">' maxStep='</span> num2str(StepLength,15)  <span class="keyword">...</span>
0303                 <span class="string">' dipole='</span> num2str(Brho*A/L,15)<span class="keyword">...</span><span class="comment">' fieldColor=0.5,.1,.0 '...' By=$B' num2str(i) A ...</span>
0304                 <span class="string">' quadrupole='</span> num2str(Brho*K,15)<span class="keyword">...</span>
0305                 <span class="string">' ironColor=1,.0,.0 kill='</span> num2str(killval) <span class="string">' '</span><span class="keyword">...</span>
0306                 <span class="string">'\n'</span><span class="keyword">...</span>
0307                 ];
0308             
0309             <span class="comment">% add to already defined</span>
0310             defined{d}=N;
0311             d=d+1;
0312                 
0313         <span class="keyword">elseif</span> multbend==2
0314              <span class="comment">% misalignaed quadrupole</span>
0315             inrad=450;
0316             outrad=500;
0317             
0318             L=L * (2*sin(A/2))/A;  <span class="comment">% Length of sector arc to length of rectangular element</span>
0319             <span class="comment">% L=L * 0.99;</span>
0320             <span class="comment">% define 1 slice</span>
0321             defB=[ defB <span class="keyword">...</span>
0322                 <span class="string">' genericquad '</span> N <span class="string">' '</span><span class="keyword">...</span>
0323                 <span class="string">' fieldLength='</span> num2str(L*1000,15) <span class="keyword">...</span><span class="comment"> % mm</span>
0324                 <span class="string">' apertureRadius='</span> num2str(inrad,15) <span class="string">' '</span><span class="keyword">...</span>
0325                 <span class="string">' ironRadius='</span> num2str(outrad,15) <span class="string">' '</span><span class="keyword">...</span>
0326                 <span class="string">' ironLength='</span> num2str(L*1000,15) <span class="string">' '</span><span class="keyword">...</span>
0327                 <span class="string">' ironColor=0/255,191/255,255/255 kill='</span> num2str(killval) <span class="string">' '</span><span class="keyword">...</span>
0328                 <span class="string">' fringe='</span> num2str(0*fringON) <span class="keyword">...</span>
0329                 <span class="string">' gradient='</span> num2str(K*Brho,15) <span class="string">' '</span><span class="keyword">...</span><span class="comment">  K</span>
0330                 <span class="string">' maxStep='</span> num2str(StepLength/2)  <span class="keyword">...</span>
0331                 <span class="string">' ironColor=1,.0,.0 kill='</span> num2str(killval) <span class="string">' '</span><span class="keyword">...</span>
0332                 <span class="string">'\n'</span><span class="keyword">...</span>
0333                 ];
0334             
0335             <span class="comment">% add to already defined</span>
0336             defined{d}=N;
0337             d=d+1;
0338         
0339         <span class="keyword">end</span>
0340     <span class="keyword">end</span>
0341     
0342     disp(totA)
0343     
0344     dipposstr=[];
0345     
0346     <span class="keyword">for</span> spl=1:split
0347         S=<a href="../../../../atmat/atphysics/findspos.html" class="code" title="function spos = findspos(line,refpts)">findspos</a>(arc,dipol(i))+(L*(spl-1/2));
0348         <span class="keyword">if</span> multbend==1
0349             
0350             dipposstr=[ dipposstr <span class="string">' \n'</span><span class="keyword">...</span>
0351                 <span class="string">'place '</span> N <span class="string">' parent=  z=0+'</span> num2str(0) <span class="string">'+0+'</span> num2str(S*1000,15) <span class="keyword">...</span>
0352                 <span class="string">' x='</span> num2str(0*L/2*tan(A/2)*1000,15) <span class="string">''</span><span class="keyword">...</span><span class="comment"> % move in by a sagitta amount</span>
0353                 <span class="string">' coordinates=centerline'</span><span class="keyword">...</span><span class="comment">' \n'...</span>
0354                 <span class="string">' rotation=Y'</span> num2str(0*A*180/pi/2,15)<span class="keyword">...</span><span class="comment">' rename=' N ' \n'...</span>
0355                 <span class="keyword">...</span><span class="comment">' By=B' num2str(i) N ...</span>
0356                 <span class="string">'\n'</span> <span class="keyword">...</span>
0357                 <span class="string">' corner C'</span> num2str(i) <span class="string">' z=0+'</span> num2str(0) <span class="string">'+0+'</span> num2str((S)*1000,15) <span class="keyword">...</span><span class="comment">-L/2</span>
0358                 <span class="string">' rotation=Y'</span> num2str(A*180/pi,15)  <span class="string">' radiusCut=100 radius='</span>  num2str((L/A)*1000,15) <span class="string">'\n'</span><span class="keyword">...</span><span class="comment">'#corner' ' parent=  z=' num2str((B{2}(i)+B{4}(i)/2)*1000,15) ... ' rotation=Y' num2str(B{3}(i)*180/pi/2,15) ' \n'...</span>
0359                 <span class="string">'\n'</span>
0360                 <span class="keyword">...</span><span class="comment">' cornerarc' ' z=0+' num2str(0) '+0+' num2str((S)*1000,15) ...-L/2</span>
0361                 <span class="keyword">...</span><span class="comment">' angle=' num2str(A*180/pi,15)  ' centerRadius='  num2str((L/A)*1000,15) '\n'...'#corner' ' parent=  z=' num2str((B{2}(i)+B{4}(i)/2)*1000,15) ... ' rotation=Y' num2str(B{3}(i)*180/pi/2,15) ' \n'...</span>
0362                 <span class="keyword">...</span><span class="comment">'\n'...</span>
0363                 ]; <span class="comment">%#ok&lt;*SAGROW&gt;</span>
0364         <span class="keyword">elseif</span> multbend==2
0365             
0366             dipposstr=[ dipposstr <span class="string">' \n'</span><span class="keyword">...</span>
0367                 <span class="string">'place '</span> N <span class="string">' parent=  z=0+'</span> num2str(0) <span class="string">'+0+'</span> num2str(S*1000,15) <span class="keyword">...</span>
0368                 <span class="string">' x='</span> num2str(-A/(K*L)*1000,15) <span class="string">''</span><span class="keyword">...</span><span class="comment"> % move in by a sagitta amount</span>
0369                 <span class="string">' coordinates=centerline'</span><span class="keyword">...</span><span class="comment">' \n'...</span>
0370                 <span class="string">' rotation=Y'</span> num2str(A*180/pi/2,15)<span class="keyword">...</span><span class="comment">' rename=' N ' \n'...</span>
0371                 <span class="keyword">...</span><span class="comment">' By=B' num2str(i) N ...</span>
0372                 <span class="string">'\n'</span> <span class="keyword">...</span>
0373                 <span class="keyword">...</span><span class="comment">' corner C' num2str(i) ' z=0+' num2str(0) '+0+' num2str((S)*1000,15) ...-L/2</span>
0374                 <span class="keyword">...</span><span class="comment">' rotation=Y' num2str(A*180/pi,15)  ' radiusCut=100 radius='  num2str((L/A)*1000,15) '\n'...'#corner' ' parent=  z=' num2str((B{2}(i)+B{4}(i)/2)*1000,15) ... ' rotation=Y' num2str(B{3}(i)*180/pi/2,15) ' \n'...</span>
0375                 <span class="keyword">...</span><span class="comment">'\n'</span>
0376                 <span class="string">' cornerarc'</span> <span class="string">' z=0+'</span> num2str(0) <span class="string">'+0+'</span> num2str((S)*1000,15) <span class="keyword">...</span><span class="comment">-L/2</span>
0377                 <span class="string">' angle='</span> num2str(A*180/pi,15)  <span class="string">' centerRadius='</span>  num2str((L/A)*1000,15) <span class="string">'\n'</span><span class="keyword">...</span><span class="comment">'#corner' ' parent=  z=' num2str((B{2}(i)+B{4}(i)/2)*1000,15) ... ' rotation=Y' num2str(B{3}(i)*180/pi/2,15) ' \n'...</span>
0378                 <span class="string">'\n'</span><span class="keyword">...</span>
0379                 ]; <span class="comment">%#ok&lt;*SAGROW&gt;</span>
0380             
0381         <span class="keyword">elseif</span> multbend==0
0382             <span class="keyword">if</span> sector==0
0383                 <span class="comment">% %  rectangular</span>
0384                 dipposstr=[ dipposstr <span class="string">' \n'</span><span class="keyword">...</span>
0385                     <span class="string">'place '</span> N <span class="string">' parent=  z=0+'</span> num2str(0) <span class="string">'+0+'</span> num2str(S*1000,15) <span class="keyword">...</span>
0386                     <span class="string">' x='</span> num2str(L/2*tan(A/2)*1000,15) <span class="string">''</span><span class="keyword">...</span><span class="comment"> % move in by a sagitta amount</span>
0387                     <span class="string">' coordinates=centerline'</span><span class="keyword">...</span><span class="comment">' \n'...</span>
0388                     <span class="string">' rotation=Y'</span> num2str(A*180/pi/2,15)<span class="keyword">...</span><span class="comment">' rename=' N ' \n'...</span>
0389                     <span class="keyword">...</span><span class="comment">' By=B' num2str(i) N ...</span>
0390                     <span class="string">'\n'</span> <span class="keyword">...</span>
0391                     <span class="string">' cornerarc'</span> <span class="string">' z=0+'</span> num2str(0) <span class="string">'+0+'</span> num2str((S-L/2)*1000,15) <span class="keyword">...</span>
0392                     <span class="string">' angle='</span> num2str(A*180/pi,15)  <span class="string">' centerRadius='</span>  num2str((L/A)*1000,15) <span class="string">'\n'</span><span class="keyword">...</span><span class="comment">'#corner' ' parent=  z=' num2str((B{2}(i)+B{4}(i)/2)*1000,15) ... ' rotation=Y' num2str(B{3}(i)*180/pi/2,15) ' \n'...</span>
0393                     <span class="string">'\n'</span><span class="keyword">...</span>
0394                     ]; <span class="comment">%#ok&lt;*SAGROW&gt;</span>
0395                 
0396             <span class="keyword">elseif</span> sector==1
0397                 <span class="comment">% % sector</span>
0398                 S=<a href="../../../../atmat/atphysics/findspos.html" class="code" title="function spos = findspos(line,refpts)">findspos</a>(arc,dipol(i))+(L*(spl-1));
0399                 
0400                 
0401                 dipposstr=[ dipposstr <span class="string">' \n'</span><span class="keyword">...</span>
0402                     <span class="string">'place '</span> N <span class="string">' parent=  z=0+'</span> num2str(0) <span class="string">'+0+'</span> num2str(S*1000,15) <span class="keyword">...</span>
0403                     <span class="string">' x='</span> num2str(0*L/2*tan(A/2)*1000,15) <span class="string">''</span><span class="keyword">...</span><span class="comment"> % move in by a sagitta amount</span>
0404                     <span class="string">' coordinates=centerline'</span><span class="keyword">...</span><span class="comment">' \n'...</span>
0405                     <span class="string">' rotation=Y'</span> num2str(0*(A*180/pi)/2,15)<span class="keyword">...</span><span class="comment">' rename=' N ' \n'...</span>
0406                     <span class="keyword">...</span><span class="comment">' By=B' num2str(i) N ...</span>
0407                     <span class="string">'\n'</span> <span class="keyword">...</span>
0408                     <span class="string">' cornerarc'</span> <span class="string">' z=0+'</span> num2str(0) <span class="string">'+0+'</span> num2str((S)*1000,15) <span class="keyword">...</span><span class="comment"> z value is the front face of the magnet</span>
0409                     <span class="string">' angle='</span> num2str(A*180/pi,15)  <span class="string">' centerRadius='</span>  num2str((L/A)*1000,15) <span class="string">'\n'</span><span class="keyword">...</span><span class="comment">'#corner' ' parent=  z=' num2str((B{2}(i)+B{4}(i)/2)*1000,15) ... ' rotation=Y' num2str(B{3}(i)*180/pi/2,15) ' \n'...</span>
0410                     <span class="string">'\n'</span><span class="keyword">...</span>
0411                     ]; <span class="comment">%#ok&lt;*SAGROW&gt;</span>
0412             <span class="keyword">end</span>
0413         <span class="keyword">end</span>
0414     <span class="keyword">end</span>
0415     plac{ord}=dipposstr;
0416     ord=ord+1;
0417     multbend=tmpmultibend;
0418 
0419 <span class="keyword">end</span>
0420 
0421 TotLength
0422 
0423 RF_on=0;
0424 <span class="comment">% plac RFC</span>
0425 <span class="comment">%length[m]        voltage[MV]                lag          freq[MHz]             harmon</span>
0426 <span class="comment">%0.501777                0.6           0.424389        476.0054439               1998</span>
0427 RF=[<span class="string">'pillbox RFC maxGradient='</span> num2str(RF_on*0.6/0.501777,15) <span class="keyword">...</span>
0428     <span class="string">' color=0.5,0.5,0 frequency=0.4760054439 innerLength=501.777 '</span><span class="keyword">...</span>
0429     <span class="string">' phaseAcc=0.424389 wallThick=100 innerRadius=1000\n'</span>];
0430 RF1pos=0*1000;
0431 plac{ord}=[<span class="string">'  # place RFC z='</span> num2str(RF1pos) <span class="string">'\n'</span>];
0432 
0433 ippos=0;
0434 Dumppos=beamstart-1;
0435 
0436 positions=[<a href="../../../../atmat/atphysics/findspos.html" class="code" title="function spos = findspos(line,refpts)">findspos</a>(arc,quadr)'; <a href="../../../../atmat/atphysics/findspos.html" class="code" title="function spos = findspos(line,refpts)">findspos</a>(arc,sextu)'; <a href="../../../../atmat/atphysics/findspos.html" class="code" title="function spos = findspos(line,refpts)">findspos</a>(arc,dipol)'; (RF1pos-TotLength)/1000; (beamstart-TotLength)/1000;(TotLength/2)/1000;TotLength*2];
0437 
0438 posString=[];
0439 <span class="keyword">for</span> i=1:length(positions)-1
0440     posString=[posString num2str(positions(i)*1000) <span class="string">','</span>];
0441 <span class="keyword">end</span>
0442 posString=[posString num2str(positions(i)*1000)];
0443 
0444 twissH=[<span class="string">'profile '</span> <span class="keyword">...</span>
0445     <span class="string">'zloop='</span> num2str(beamstart*0) <span class="string">':'</span> num2str(TotLength*3) <span class="string">':1000 '</span><span class="keyword">...</span>
0446     <span class="keyword">...</span><span class="comment">' z=' posString ...</span>
0447     <span class="string">' file=twissLER particle='</span> particle <span class="keyword">...</span>
0448     <span class="string">' coordinates=centerline\n'</span>]; <span class="comment">%   ' coordinates=reference\n'];</span>
0449 
0450 <span class="comment">%twissH=['profile zloop=' num2str(beamstart*0) ':' num2str(beamstart+TotLength*2.5) ':1000 file=twissHER particle=' particle ...</span>
0451 <span class="comment">%      ' coordinates=centerline\n']; %   ' coordinates=reference\n'];</span>
0452 
0453 dump=[<span class="string">'tubs DUMP innerRadius=0.01 outerRadius=300 length=10 kill=1 material=Cu color=0.2,0.2,0\n '</span><span class="keyword">...</span>
0454     ];
0455 
0456 plac{ord+1}=[<span class="string">'# place ip parent=  z='</span> num2str(ippos,15) <span class="string">' \n'</span> ];
0457 plac{ord+2}=[<span class="keyword">...</span>
0458     posbeam <span class="string">'place BeamVis z='</span> num2str(beamstart,15) <span class="string">' y=101 \n'</span>
0459     ];
0460 plac{ord+3}=[<span class="string">'# place DUMP parent=  z='</span> num2str(Dumppos,15) <span class="string">' \n'</span>];
0461 
0462 <span class="comment">%%%%%%                             RF1         RF2                   beam</span>
0463 [s,ind]=sort([<a href="../../../../atmat/atphysics/findspos.html" class="code" title="function spos = findspos(line,refpts)">findspos</a>(arc,quadr)'; <a href="../../../../atmat/atphysics/findspos.html" class="code" title="function spos = findspos(line,refpts)">findspos</a>(arc,sextu)'; <a href="../../../../atmat/atphysics/findspos.html" class="code" title="function spos = findspos(line,refpts)">findspos</a>(arc,dipol)'; RF1pos/1000;beamstart/1000;Dumppos/1000;TotLength/1000]); <span class="comment">% in m</span>
0464 
0465 
0466 R=[head defQ defS defB RF dump];
0467 RPlace=[plac{ind}];
0468 
0469 
0470 outtext=char([<span class="keyword">...</span>
0471     bigmondo <span class="keyword">...</span>
0472     <span class="keyword">...</span><span class="comment"> definitions</span>
0473     R <span class="keyword">...</span><span class="comment">  RING</span>
0474     RPlace <span class="keyword">...</span><span class="comment">  Place RING magnets</span>
0475     <span class="string">' particlecolor e-=0,0,1 e+=1,0,0 \n'</span><span class="keyword">...</span><span class="comment">  electron is blue and positron is red.</span>
0476     <span class="keyword">...</span><span class="comment">'g4ui when=4 ''/vis/open OGL''\n'...</span>
0477     <span class="string">'g4ui when=4 ''/vis/viewer/set/viewpointThetaPhi 90 90''\n'</span><span class="keyword">...</span>
0478     <span class="string">'g4ui when=4 ''/vis/viewer/set/style wireframe''\n'</span><span class="keyword">...</span>
0479     <span class="string">'g4ui when=4 ''/run/beamOn '</span> num2str(Nevents*2) <span class="string">' ''\n'</span><span class="keyword">...</span>
0480     <span class="keyword">...</span><span class="comment"> 'g4ui when=4 ''vis/ogl/printEPS''\n'...</span>
0481     ]);
0482 <span class="comment">% lattice 'g4ui when=4 ''/vis/viewer/set/style wireframe''\n'...    'g4ui ''/run/beamOn 20''\n'...</span>
0483 out=fopen(nameG4bllat,<span class="string">'w+'</span>);
0484 fprintf(out,outtext);
0485 
0486 fclose(<span class="string">'all'</span>);
0487 <span class="comment">% clear defQ</span>
0488 <span class="comment">% clear defS</span>
0489 <span class="comment">% clear defB</span>
0490 <span class="comment">% clear plac ind ord</span>
0491 <span class="comment">% clear defined</span>
0492 disp(<span class="string">'--- DONE ---'</span>)</pre></div>
<hr>
<hr><address>GitHub Website <strong><a href="https://github.com/atcollab/at" target="_parent">at</a></strong> &copy; 2018</address>
<br />
<address>Generated on Sun 04-Mar-2018 00:43:10 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>